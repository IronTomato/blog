StringBuffer与StringBuilder的区别
=================================

“StringBuffer与StringBuilder的区别”似乎是一道相当热门的Java面试题，网上有不少讨论，我参加面试时也碰到过几次，关于它的答案，网上一搜一箩筐，大体都是讲一个线程安全但比较慢，一个非线程安全但比较快。但当我对这两个类有更多了解之后，我认为这种答案有点和稀泥甚至是误导。

历史
----
首先，存在这么两个类本身就是一件奇怪的事了，它们的API完全相同，除了类型声明和构造方法的不同之外，实际使用时，我们几乎感受不到它们有什么区别，它们的存在除了引起我们的疑惑之外，还有其他作用么?
这里面有点历史原因，StringBuffer是JDK1.0时代就存在的“元老”，和其他诸如Vector，HashTable这些JDK1.0时代的“元老”一样，它全部的（我没有一个个核对，即使不是全部也是几乎全部）public方法都加了synchronized关键字修饰来获得所谓的线程安全性。  
但是很显然对所有方法进行同步的做法有点粗鲁，同步方法是需要付出性能作为代价的，而我们并不总是需要同步方法带来的线程安全性。 

作用
----
StringBuffer/StringBuilder除了供我们直接调用之外，其更主要的作用是用来实现字符串相加。  
我们知道Java可以用`+`号来连接两个字符串，这是Java为数不多的几个语法糖之一，它的实现是依靠编译器和StringBuffer/StringBuilder来完成的。  
当代码中出现`+`号连接的字符串时，编译器会对字符串进行检查。  
如果这些字符串全部都是字面量(用`"`包围直接在源码文件中提供的字符串)或者字符串常量(用`static final String`声明的字符串)，编译器会直接计算出连接后的字符串并输出到class文件中，代码运行时只有一个连接完成的字符串，而没有多个字符串进行连接的过程。  
反编译class文件可以看出[]  

如果用于连接的字符串中包含字符串变量，那么编译器会将代码转换为新建一个字符串累加器对象，然后对每个字符串逐个调用累加器的append方法来拼接，最后调用累加器的toSting方法转换回String类型。这里的字符串累加器，在1.4以及更低版本的JDK中，就是StringBuffer，而在1.5以及更高版本的JDK中，是StringBuilder。  
因此下面的代码是等效的，
反编译class文件可以看出[]

线程安全
-------
可能有人注意到了，我在上面提到StringBuffer的线程安全性时用了“所谓的”，因为我觉得对于一个包含可变状态的类来说，线程安全不是一个那么容易获得的属性，将所有公共方法声明为同步方法，并不能保证可以放心地在多线程场景中使用这个类。关于线程安全的更多问题，可以参考我的另一个主题[线程安全](../thread-safe/thread-safe.md)。  
未使用同步方法的StringBuilder在多线程场景下可能出现非常糟糕的情况，但用了同步方法的StringBuffer情况也没有好到哪里去。
考虑这样两次调用：

	sb.append("A");
	sb.append("B");

这里`sb`是一个字符串累加器变量，不管它是StringBuffer还是StringBuilder，在单线程场景下，这样的两次调用都会产生一个`"AB"`序列，那么将这两条语句放在不同的两条线程中执行会怎么样呢?  
如果`sb`是StringBuilder，可能出现A B AB BA  
如果sb是StringBuffer，则可能是AB BA
可以看出StringBuffer比StringBuilder的情况好一点，同步方法保证了一个方法在执行的时候，另一个方法不会横插一脚，破坏本次调用的结果，但是两次调用的顺序是没有办法保证的。
调用顺序是否会对最终结果产生影响，要取决于类的具体性质，如果是像`Set`这样的无序的数据结构，两次`add`操作的顺序就没那么重要了，而字符串是一个有序的字符序列，显然AB 和BA不是同一个序列，因此同步方法依然无法保证多线程场景下我们能获取到一个期望的结果。  
因此，当你在考虑StringBuffer比StringBuilder更具有线程安全性这个问题的时候，可能在多个线程中共享字符串累加器本身就不是一个好主意，应该考虑其他的实现方案避免这种共享，或者改为共享String这种不可变类的对象。

总结
----
StringBuilder是用来代替StringBuffer的，当需要一个字符串累加器的时候，StringBuilder几乎总是优先的选项，至于StringBuffer，应该让它慢慢消逝在历史的长河中，它的适用场景大概只剩下这么两个了：  
1. 需要维护或兼容JDK1.4以及以下版本的代码  
2. 出现在“StringBuffer与StringBuilder的区别”这道题里用来考验初学者  